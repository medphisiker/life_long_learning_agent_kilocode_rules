# Сервис Агента (agent_service)

Основной оркестратор системы, реализующий логику LLM-агента, управление сессиями и интеграцию с внешними инструментами (RAG, генератор тестов, Tavily, Context7).

## Структура проекта

- `app.py` — Точка входа FastAPI, настройка роутов и middleware.
- `agent_system.py` — Глобальная система управления агентами и сессиями.
- `agent_session.py` — Логика отдельной пользовательской сессии (state machine агента).
- `llm_service/` — Модуль взаимодействия с LLM провайдерами.
    - `llm_client.py` — Универсальный клиент (OpenAI, OpenRouter, Mistral, Z.ai).
    - `utils.py` — Вспомогательные функции для обработки HTTP-ответов и таймаутов.
- `prompts/` — Шаблоны системных и функциональных промптов.
- `langchain_tools.py` — Определение инструментов (tools) для LangChain агента.
- `settings.py` — Конфигурация через Pydantic Settings.
- `prompt_loader.py` — Загрузчик текстовых промптов из файлов.
- `logger.py` — Настройка логирования.
- `tests/` — Тестовое покрытие:
    - `components/` — Юнит-тесты компонентов и интеграций с провайдерами.
    - `pipeline/` — Интеграционные тесты сценариев (RAG, Quiz, Chit-chat).

## Файлы конфигурации

- `docker-compose-dev.yml` — Сборка для разработки с пробросом кода (volumes).
- `docker-compose-prod.yml` — Запуск стабильной версии из GHCR.
- `app_settings-dev.json` / `app_settings-prod.json` — Настройки уровней окружения.
- `.env_example` — Шаблон переменных окружения (API ключи).

## Ключевые порты
- `8250` (DEV) / `8270` (PROD) — API сервис агента.

## Сетевое взаимодействие (Docker Networks)

Сервис агента взаимодействует с другими компонентами системы через выделенные Docker-сети. В режиме разработки (DEV) используются внешние сети, создаваемые соответствующими сервисами:

- `rag_rag_network` (внешняя) — для связи с RAG сервисом.
- `test_generator_default` (внешняя) — для связи с сервисом генерации тестов.
- `web_ui_network_dev` — внутренняя сеть для связи с Web UI (Backend).

При запуске через `docker-compose-dev.yml` агент ожидает, что сервисы `rag`, `test_generator` и `web_ui_service` уже запущены и их сети доступны.

## Поддерживаемые провайдеры LLM
- **Z.ai** (по умолчанию, модель `glm-4.6v`)
- **OpenRouter**
- **OpenAI**
- **Mistral**