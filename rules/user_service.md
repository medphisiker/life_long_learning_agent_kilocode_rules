# Сервис Пользователей (user_service)

Сервис для управления пользователями, их аутентификацией, персональными настройками LLM и историей взаимодействия с системой.

## Функциональность

- **Аутентификация**: JWT-based аутентификация (OAuth2 Password Flow).
- **Управление профилем**: Хранение данных пользователя.
- **Настройки LLM**: Персональные предпочтения провайдеров и моделей для Агента, RAG и Генератора тестов.
- **История сессий**: Хранение метаданных сессий чата (связь с `agent_service`).
- **Лимиты сессий**: Ограничение количества сессий на пользователя (`max_user_sessions`, по умолчанию **10**). Автоматическая ротация (удаление старых) при превышении.
- **Результаты квизов**: Хранение истории прохождения тестов (связь с `test_generator`).

## Стек технологий

- **FastAPI**: Веб-фреймворк.
- **PostgreSQL**: Реляционная база данных для персистентного хранения.
- **SQLAlchemy (Async)**: ORM для работы с БД.
- **Alembic**: Миграции базы данных.
- **Passlib**: Хеширование паролей (используется `bcrypt==4.0.1` для совместимости).
- **Python-jose**: Работа с JWT токенами.

## Структура проекта

- `app/api/` — Роуты для аутентификации, настроек и истории.
- `app/core/` — Конфигурация, безопасность и JWT логика.
- `app/db/` — Инициализация БД и асинхронные сессии.
- `app/models/` — Определение таблиц SQLAlchemy.
- `app/schemas/` — Pydantic модели для API.
- `scripts/register_user.py` — CLI инструмент для регистрации пользователей администратором.
- `scripts/list_users.py` — Просмотр списка всех пользователей и их ролей.
- `scripts/delete_user.py` — Удаление пользователя и связанных данных.
- `scripts/bulk_create_users.py` — Массовое создание пользователей из JSON.
- `scripts/bulk_delete_users.py` — Массовое удаление пользователей из JSON.

## Взаимодействие

- **Web UI Backend**: Выступает в роли шлюза, проксирует запросы на логин и настройки в `user_service`.
- **Сетевое взаимодействие**: В Docker-сетях сервис доступен по алиасу `user-service`. В DEV-окружении проброшен порт `8010`.
- **База данных**: Использует внешний том `user_postgres_data` для сохранения данных.

## Файлы конфигурации

- `docker-compose-dev.yml` — Локальная сборка и запуск для разработки.
- `docker-compose-prod.yml` — Запуск стабильной версии из GHCR.
- `docker-compose-bootstrap.yml` — Инициализация базы данных (миграции и создание тестового пользователя).

## Безопасность

- Доступ к данным строго ограничен владельцем (User Isolation).
- Пароли хранятся только в виде хешей (bcrypt).