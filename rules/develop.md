# Правила разработки (Development Rules)

Данный документ определяет стандарты и подходы к разработке, отладке и тестированию в проекте.

## 1. Конфигурация и Docker
- **Версионность образов**: Всегда указывай точные версии (tags) для готовых Docker-образов (например, `postgres:15.10-alpine`, `redis:7.4.2-alpine`, `qdrant/qdrant:v1.12.4`). Использование тега `latest` запрещено для обеспечения стабильности окружения.
- **Сетевое взаимодействие**: Все сервисы должны использовать именованные внешние сети для связи между собой.

## 2. Принципы работы с кодом
- **Объективность**: Не предполагай поведение системы, если оно не описано.
- **Верификация**: Всегда проверяй текущую реализацию через `codebase_search` перед внесением изменений.
- **Актуальность**: Сверяйся с документацией библиотек через `context7` (особенно при возникновении ошибок).
- **Исследование**: Используй `tavily` для поиска решений в интернете, если проблема выходит за рамки текущей кодовой базы.

*   **Инициализация (Code Index)**: В начале КАЖДОЙ задачи ОБЯЗАТЕЛЬНО выполните последовательность для актуализации индекса:
    1.  `set_project_path` (указать путь к воркспейсу).
    2.  `refresh_index`.
    3.  `build_deep_index`.
    4.  `get_settings_info` (для проверки).

## Обновление базы знаний (Memory Bank)
*   После успешного завершения задачи ОБЯЗАТЕЛЬНО обновляйте соответствующие файлы в `.kilocode/rules/`.

## 2. Тестирование
- **Интеграционные тесты**: Должны запускаться внутри соответствующих Docker-контейнеров.
- **Сценарии NetRunner**: При обновлении графа агента всегда запускай `web_ui_service/tests/test_netrunner_scenarios.py`.
- **WebSocket события**: При тестировании асинхронных взаимодействий проверяй последовательность событий (steps/tools) через WebSocket, а не только финальный текстовый ответ.

## 3. UI/UX Стандарты (v3.0)
- **Дизайн**: Все новые компоненты должны следовать концепции «Нетраннерской Деки» (скошенные углы 15px, неоновое свечение, моноширинные шрифты).
- **Цвета**: Primary Cyan (#00FFCC), Secondary Lime (#DAFF00), Background (#05070A).
- **Формулы**: Использовать KaTeX для математических выражений. В режиме Preview Деки рендеринг должен быть мгновенным.

## 4. NetRunner Protocol (v3.1)
При разработке узлов графа `AgentSystem` соблюдай следующие правила:
- **CLI-команды**: Слэш-команды (`/finish_quizz`, `/skip_question`) имеют приоритет и должны обрабатываться в `planner_node` до вызова LLM.
- **Контекст квиза**: При ответе на уточняющие вопросы (RAG) в процессе квиза, необходимо возвращать пользователя к текущему вопросу, используя маркер `[SYSTEM: QUIZ_CONTEXT_RESUMED]`.
- **Interaction Modes**: Поддержка `interaction_mode` (`AI_SYNC`, `ANSWER_QUIZ`). Режим `ANSWER_QUIZ` принудительно устанавливает интент `quiz_answering`.
- **Интенты**: Поддерживай новые типы интентов (`skip_question`, `evaluate_quiz`) в `IntentModel` и промптах.
- **Message Types**: Новый тип `quizz_question` для отделения вопросов теста от обычных сообщений ассистента.

## 4. Документирование
- Любые изменения в логике графа должны быть отражены в `agent_service/docs/agent_documentation.md` (включая Mermaid диаграммы).
- Новые идеи по UI/UX фиксируются в `docs/ideas/`.